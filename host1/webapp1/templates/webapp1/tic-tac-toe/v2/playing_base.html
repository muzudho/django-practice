{% load static %} {% comment %} ğŸ‘ˆã‚ã¨ã§ static "URL" ã‚’ä½¿ã†ã®ã§ load static ã—ã¾ã™ {% endcomment %}
<!DOCTYPE html>
<html>
    <head>
        <link rel="shortcut icon" type="image/png" href="{% static 'favicon.ico' %}" />
        <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet" />
        <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet" />
        <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui" />
        <title>Tic Tac Toe</title>
    </head>
    <body>
        <div id="app">
            <v-app>
                <v-main>
                    <v-container>
                        <h1>TIC TAC TOE</h1>
                        <h3>Welcome to room_{{dj_room_name}}</h3>
                    </v-container>

                    <form name="form1" method="POST">
                        {% csrf_token %}
                        <v-container>
                            <v-row justify="center" dense>
                                <v-col>
                                    {% comment %} Vue ã§äºŒé‡æ³¢æ‹¬å¼§ï¼ˆbracesï¼‰ã¯å¤‰æ•°ã®å±•é–‹ã«ä½¿ã£ã¦ã„ã‚‹ã“ã¨ã‹ã‚‰ã€ Python ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«äºŒé‡æ³¢æ‹¬å¼§ã‚’å¤‰æ•°ã®å±•é–‹ã«ä½¿ã‚ãªã„ã‚ˆã† verbatim ã§æŒ‡ç¤ºã—ã¾ã™ã€‚ {% endcomment %}
                                    <!-- -->
                                    {% verbatim %}
                                    <v-btn id="square0" v-on:click="clickSquare(0)">{{label0}}</v-btn>
                                    <v-btn id="square1" v-on:click="clickSquare(1)">{{label1}}</v-btn>
                                    <v-btn id="square2" v-on:click="clickSquare(2)">{{label2}}</v-btn>
                                    {% endverbatim %}
                                </v-col>
                            </v-row>
                            <v-row justify="center" dense>
                                <v-col>
                                    {% verbatim %}
                                    <v-btn id="square3" v-on:click="clickSquare(3)">{{label3}}</v-btn>
                                    <v-btn id="square4" v-on:click="clickSquare(4)">{{label4}}</v-btn>
                                    <v-btn id="square5" v-on:click="clickSquare(5)">{{label5}}</v-btn>
                                    {% endverbatim %}
                                </v-col>
                            </v-row>
                            <v-row justify="center" dense>
                                <v-col>
                                    {% verbatim %}
                                    <v-btn id="square6" v-on:click="clickSquare(6)">{{label6}}</v-btn>
                                    <v-btn id="square7" v-on:click="clickSquare(7)">{{label7}}</v-btn>
                                    <v-btn id="square8" v-on:click="clickSquare(8)">{{label8}}</v-btn>
                                    {% endverbatim %}
                                </v-col>
                            </v-row>
                        </v-container>

                        <!-- `po_` ã¯ POSTé€ä¿¡ã™ã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼åã®ç›®å° -->
                        <input type="hidden" name="po_room_name" value="{{dj_room_name}}" />
                        <input type="hidden" name="po_my_piece" value="{{dj_my_piece}}" />
                    </form>
                    {% block footer_section1 %}
                    <!-- ãƒœã‚¿ãƒ³ç­‰ã‚’è¿½åŠ ã—ãŸã„ãªã‚‰ã€ã“ã“ã«æŒ¿ã—ã“ã‚ã‚‹ -->
                    {% endblock footer_section1 %}
                    <v-container>
                        <v-alert type="info" color="green" v-show="isYourTurn">Your turn. Place your move <strong>{{dj_my_piece}}</strong></v-alert>
                        <v-alert type="warning" color="orange" v-show="isVisibleAlertWaitForOther">Wait for other to place the move</v-alert>
                        {% verbatim %}
                        <v-alert type="success" color="blue" v-show="isGameover">{{gameover_message}}</v-alert>
                        {% endverbatim %}
                        <v-alert type="warning" color="orange" v-show="isAlertReconnectingShow()">Reconnecting...</v-alert>
                    </v-container>
                </v-main>
            </v-app>
        </div>

        <script src="{% static 'webapp1/tic-tac-toe/v2/things.js' %}"></script>
        <script src="{% static 'webapp1/tic-tac-toe/v2/concepts.js' %}"></script>
        <script src="{% static 'webapp1/tic-tac-toe/v2/connection.js' %}"></script>
        <script src="{% static 'webapp1/tic-tac-toe/v2/judge_ctrl.js' %}"></script>
        <script src="{% static 'webapp1/tic-tac-toe/v2/position.js' %}"></script>
        <script src="{% static 'webapp1/tic-tac-toe/v2/message_receiver.js' %}"></script>
        <script src="{% static 'webapp1/tic-tac-toe/v2/message_sender.js' %}"></script>
        <script src="{% static 'webapp1/tic-tac-toe/v2/user_ctrl.js' %}"></script>
        <script src="{% static 'webapp1/tic-tac-toe/v2/building.js' %}"></script>
        <!--                    ==================================
                                1
        1. host1/webapp1/static/webapp1/tic-ta-toe/v2/building.js
                 ================================================
        -->

        <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
        <script>
            /**
             * å†æ¥ç¶šé–¢æ•°ã®ä½œæˆ
             * @return ãƒ©ãƒ ãƒ€é–¢æ•°
             */
            function packReconnect() {
                // 5ç§’å¾Œã«1å›ã ã‘å†æ¥ç¶šã«ãƒˆãƒ©ã‚¤ã—ã¾ã™ã€‚
                // ãã®ã‚ã¨æ¥ç¶šãŒåˆ‡ã‚Œã‚Œã° ã¾ãŸå†æ¥ç¶šãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã®ã§é€£ç¶šã—ã¾ã™
                return () => {
                    console.log("[Reconnect] Start...");
                    vue1.building.connection.isReconnectingDisplay = true;

                    setTimeout(() => {
                        // ã“ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã§ã¯ã€ this ã®æŒ‡ã—ã¦ã„ã‚‹ã‚‚ã®ãŒ ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã®å¤–å´ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ãªã„ã®ã§æ³¨æ„
                        console.log("[Reconnect] Try...");
                        vue1.building.connect();

                        vue1.building.connection.isReconnectingDisplay = false;
                        console.log("[Reconnect] End");
                    }, 5000);
                };
            }

            let vue1 = new Vue({
                el: "#app",
                vuetify: new Vuetify(),
                data: {
                    building: new Building(
                        packSetMessageFromServer(),
                        packReconnect(),
                        // `po_` ã¯ POSTé€ä¿¡ã™ã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼åã®ç›®å°
                        // éƒ¨å±‹å
                        document.forms["form1"]["po_room_name"].value,
                        // è‡ªåˆ†ã®é§’ã€‚ X ã‹ O
                        document.forms["form1"]["po_my_piece"].value,
                        // æ¥ç¶šæ–‡å­—åˆ—ã‚’è¿”ã™é–¢æ•° (roomName, myPiece)=>{return connectionString;}
                        /**
                         * æ¥ç¶šæ–‡å­—åˆ—ã¸å¤‰æ›
                         */
                        (roomName, myPiece) => {
                            // æ¥ç¶šæ–‡å­—åˆ—
                            // `dj_` ã¯ Djangoã§ãƒ¬ãƒ³ãƒ€ãƒ¼ã™ã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼åã®ç›®å°
                            const connectionString = `ws://${window.location.host}{{dj_path_of_ws_playing}}${roomName}/`;
                            //                        ----]----------------------]-------------------------------------
                            //                        1    2                      3
                            // 1. ãƒ—ãƒ­ãƒˆã‚³ãƒ«ï¼ˆWeb socketï¼‰
                            // 2. ãƒ›ã‚¹ãƒˆ ã‚¢ãƒ‰ãƒ¬ã‚¹
                            // 3. ãƒ‘ã‚¹
                            console.log(`[lambda] convertPartsToConnectionString roomName=${roomName} è‡ªåˆ†ã®æ‰‹ç•ª=${myPiece} connectionString=${connectionString}`);

                            return connectionString;
                        },
                        /**
                         * å‡ãƒœã‚¿ãƒ³ã®ãƒ©ãƒ™ãƒ«ã®è¨­å®š
                         *
                         * @param {number} sq - Square; 0 <= sq
                         * @param {*} piece - text
                         */
                        (sq, piece)=>{
                            console.log(`[lambda] setLabelOfButton sq=${sq} piece=${piece} this=${this}`);
                            switch (sq) {
                                case 0:
                                    // * ã“ã“ã§ã¯ this ã¯Windowã‚’æŒ‡ã—ã¦ã„ã‚‹ã®ã§ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ä½¿ã„ã¾ã™
                                    vue1.label0 = piece;
                                    break;
                                case 1:
                                    vue1.label1 = piece;
                                    break;
                                case 2:
                                    vue1.label2 = piece;
                                    break;
                                case 3:
                                    vue1.label3 = piece;
                                    break;
                                case 4:
                                    vue1.label4 = piece;
                                    break;
                                case 5:
                                    vue1.label5 = piece;
                                    break;
                                case 6:
                                    vue1.label6 = piece;
                                    break;
                                case 7:
                                    vue1.label7 = piece;
                                    break;
                                case 8:
                                    vue1.label8 = piece;
                                    break;
                                default:
                                    alert(`[Error] sq=${sq}`);
                                    break;
                            }
                        },
                    ),
                    label0: PC_EMPTY_LABEL,
                    label1: PC_EMPTY_LABEL,
                    label2: PC_EMPTY_LABEL,
                    label3: PC_EMPTY_LABEL,
                    label4: PC_EMPTY_LABEL,
                    label5: PC_EMPTY_LABEL,
                    label6: PC_EMPTY_LABEL,
                    label7: PC_EMPTY_LABEL,
                    label8: PC_EMPTY_LABEL,
                    isYourTurn: false,
                    isGameover: false,
                    // ã€Œç›¸æ‰‹ã®æ‰‹ç•ªã«ç€æ‰‹ã—ãªã„ã§ãã ã•ã„ã€ã¨ã„ã†ã‚¢ãƒ©ãƒ¼ãƒˆã®å¯è¦–æ€§
                    isVisibleAlertWaitForOther: false,
                    roomState: new RoomState(RoomState.none,(oldValue, newValue)=>{
                        // changeRoomState
                        console.log(`[data roomState changeRoomState] state old=${oldValue} new=${newValue}`);
                        vue1.raiseRoomStateChanged();
                    }),
                    gameover_message : "",
                    messages: {
                        draw: "It's a draw.",
                        youLose: "You lose.",
                        youWin: "You win!",
                        {% block appendix_message %}
                        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ ã—ãŸã‘ã‚Œã°ã€ã“ã“ã«æŒ¿ã—ã“ã‚ã‚‹
                        {% endblock appendix_message %}
                    }
                },
                // page loaded
                mounted: () => {
                    // ã“ã“ã§ Vue ã®æº–å‚™å®Œäº†å¾Œã®å‡¦ç†ãŒã§ãã‚‹ã€‚
                    // ãŸã ã—ã€ã¾ã  this ã¯åˆæœŸåŒ–ã•ã‚Œã¦ãªã„
                },
                methods: {
                    // å¯¾å±€é–‹å§‹æ™‚
                    onStart() {
                        console.log("[methods onStart]");

                        // ã€Œç›¸æ‰‹ã®æ‰‹ç•ªã«ç€æ‰‹ã—ãªã„ã§ãã ã•ã„ã€ã¨ã„ã†ã‚¢ãƒ©ãƒ¼ãƒˆã®éè¡¨ç¤º
                        this.isVisibleAlertWaitForOther = false;

                        // å…ˆã« å¯¾å±€ä¸­çŠ¶æ…‹ ã«ã—ã¦ãŠã„ã¦ã‹ã‚‰ã€ã‚¨ãƒ³ã‚¸ãƒ³ã‚’ã‚¹ã‚¿ãƒ¼ãƒˆã•ã›ã¦ãã ã•ã„
                        this.roomState.value = RoomState.playing;
                        this.building.start();


                        // ãƒœã‚¿ãƒ³ã®ãƒ©ãƒ™ãƒ«ã‚’ã‚¯ãƒªã‚¢ãƒ¼
                        for (let sq = 0; sq < BOARD_AREA; sq += 1) {
                            this.building.setLabelOfButton(sq, PC_EMPTY_LABEL);
                        }

                        // ãƒ€ãƒ³ãƒ—
                        this.dump();
                    },
                    /**
                     * å‡ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ã
                     * @param {*} sq - Square; 0 <= sq
                     */
                    clickSquare(sq) {
                        console.log(`[methods clickSquare] gameoverSet:${this.building.gameoverSet.value}`);
                        if (this.building.gameoverSet.value != GameoverSet.none) {
                            // Ban on illegal move
                            console.log(`Ban on illegal move. gameoverSet:${this.building.gameoverSet.value}`);
                            return;
                        }

                        if (this.building.position.board.getPieceBySq(sq) == PC_EMPTY) {
                            if (!this.building.position.myTurn.isTrue) {
                                // Wait for other to place the move
                                console.log("Wait for other to place the move");
                                this.isVisibleAlertWaitForOther = true;
                            } else {
                                // ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”ã‚’å¾…ãŸãšï¼‰ç›¸æ‰‹ã®æ‰‹ç•ªã«å¤‰æ›´ã—ã¾ã™
                                this.building.position.myTurn.isTrue = false;

                                if (this.building.gameoverSet.value != GameoverSet.none) {
                                    // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼å¾Œã«é§’ã‚’ç½®ã„ã¦ã¯ã„ã‘ã¾ã›ã‚“
                                    console.log(`warning of illegal move. gameoverSet:${this.building.gameoverSet.value}`);
                                    return;
                                }

                                // è‡ªåˆ†ã®ä¸€æ‰‹
                                this.building.userCtrl.doMove(this.building.position, this.building.myPiece, parseInt(sq));
                            }
                        }
                    },
                    /**
                     * å¯¾å±€ã¯çµ‚äº†ã—ã¾ã—ãŸ
                     */
                    onGameover(winner) {
                        console.log(`[methods onGameover] winner=${winner}`);
                        this.building.winner = winner;
                        this.roomState.value = RoomState.none; // ç”»é¢ã‚’å¯¾å±€çµ‚äº†çŠ¶æ…‹ã¸

                        this.gameover_message = this.createGameoverMessage();
                    },
                    /**
                     * ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ
                     */
                    createGameoverMessage() {
                        {% block create_gameover_message %}
                        // è¿”å´å€¤ã‚’å¤‰ãˆãŸã„ãªã‚‰ã€ã“ã“ã«æŒ¿ã—ã“ã‚ã‚‹
                        {% endblock create_gameover_message %}

                        switch (this.building.gameoverSet.value) {
                            case GameoverSet.draw:
                                return this.messages.draw;
                            case GameoverSet.win:
                                return this.messages.youWin;
                            case GameoverSet.lose:
                                return this.messages.youLose;
                            case GameoverSet.none:
                                // ã“ã“ã«æ¥ã‚‹ã®ã¯ãŠã‹ã—ã„
                                return "";
                            default:
                                throw `unknown this.building.gameoverSet.value = ${this.building.gameoverSet.value}`;
                        }
                    },
                    /**
                     * (1) å¯¾å±€ä¸­ã‹
                     * (2) è‡ªåˆ†ã®æ‰‹ç•ªã‹
                     */
                    updateYourTurn(){
                        console.log(`[methods updateYourTurn 1] this.roomState=${this.roomState.value} this.building.position.myTurn.isTrue=${this.building.position.myTurn.isTrue}`);
                        let isYourTurn = this.roomState.value == RoomState.playing && this.building.position.myTurn.isTrue;

                        {% block isYourTurn_patch1 %}
                        // æ¡ä»¶ã‚’è¿½åŠ ã—ãŸã„ãªã‚‰ã€ã“ã“ã«æŒ¿ã—ã“ã‚ã‚‹
                        {% endblock isYourTurn_patch1 %}

                        console.log(`[methods updateYourTurn 2] isYourTurn=${isYourTurn}`);

                        // v-show="" ã¯è¤‡é›‘ãªãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŒ‡å®šã™ã‚‹ã¨å‹•ã‹ãªã„ã‚ˆã†ãªã®ã§ã€ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã—ã¾ã™
                        this.isYourTurn = isYourTurn;
                    },
                    raiseRoomStateChanged() {
                        console.log(`[methods raiseRoomStateChanged] roomState=${this.roomState.value}`);
                        this.isGameover = this.roomState.value == RoomState.none;

                        this.updateYourTurn();
                    },
                    raiseMyTurnChanged() {
                        console.log(`[methods raiseMyTurnChanged]`);
                        this.updateYourTurn();
                    },
                    raisePositionChanged() {
                        console.log(`[methods raisePositionChanged]`);
                        this.raiseMyTurnChanged();
                    },
                    /**
                     * å†æ¥ç¶šä¸­è¡¨ç¤ºä¸­ãªã‚‰ã€ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å¸¸æ™‚è¡¨ç¤º
                     */
                    isAlertReconnectingShow() {
                        return this.building.connection.isReconnectingDisplay;
                    },
                    {% block methods_footer %}
                    // ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ã—ãŸã‘ã‚Œã°ã€ã“ã“ã«æŒ¿ã—ã“ã‚ã‚‹
                    {% endblock methods_footer %}
                    /**
                     * ãƒ€ãƒ³ãƒ—
                     */
                    dump() {
                        console.log(`[DUMP] vue1\n${this.building.dump("")}`)
                    },
                },
            });
        </script>
    </body>
</html>
