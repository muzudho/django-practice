{% load static %} {% comment %} 👈あとで static "URL" を使うので load static します {% endcomment %}
<!DOCTYPE html>
<html>
    <head>
        <link rel="shortcut icon" type="image/png" href="{% static 'favicon.ico' %}" />
        <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet" />
        <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet" />
        <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui" />
        <title>Tic Tac Toe</title>
    </head>
    <body>
        <div id="app">
            <v-app>
                <v-main>
                    <v-container>
                        <h1>TIC TAC TOE</h1>
                        <h3>Welcome to room_{{room_name}}</h3>
                    </v-container>

                    <form name="form1" method="POST">
                        {% csrf_token %}
                        <v-container>
                            <v-row justify="center" dense>
                                <v-col>
                                    {% comment %} Vue で二重波括弧（braces）は変数の展開に使っていることから、 Python のテンプレートに二重波括弧を変数の展開に使わないよう verbatim で指示します。 {% endcomment %}
                                    <!-- -->
                                    {% verbatim %}
                                    <v-btn id="square0" v-on:click="clickSquare(0)">{{label0}}</v-btn>
                                    <v-btn id="square1" v-on:click="clickSquare(1)">{{label1}}</v-btn>
                                    <v-btn id="square2" v-on:click="clickSquare(2)">{{label2}}</v-btn>
                                    {% endverbatim %}
                                </v-col>
                            </v-row>
                            <v-row justify="center" dense>
                                <v-col>
                                    {% verbatim %}
                                    <v-btn id="square3" v-on:click="clickSquare(3)">{{label3}}</v-btn>
                                    <v-btn id="square4" v-on:click="clickSquare(4)">{{label4}}</v-btn>
                                    <v-btn id="square5" v-on:click="clickSquare(5)">{{label5}}</v-btn>
                                    {% endverbatim %}
                                </v-col>
                            </v-row>
                            <v-row justify="center" dense>
                                <v-col>
                                    {% verbatim %}
                                    <v-btn id="square6" v-on:click="clickSquare(6)">{{label6}}</v-btn>
                                    <v-btn id="square7" v-on:click="clickSquare(7)">{{label7}}</v-btn>
                                    <v-btn id="square8" v-on:click="clickSquare(8)">{{label8}}</v-btn>
                                    {% endverbatim %}
                                </v-col>
                            </v-row>
                        </v-container>
                        <input type="hidden" name="room_name" value="{{room_name}}" />
                        <input type="hidden" name="my_piece" value="{{my_piece}}" />
                    </form>
                    {% block footer_section1 %}
                    <!-- あれば、ここにボタンを置く -->
                    {% endblock footer_section1 %}
                    <v-container>
                        <v-alert type="info" color="green" v-show="isAlertYourMoveShow()">Your turn. Place your move <strong>{{my_piece}}</strong></v-alert>
                        <v-alert type="warning" color="orange" v-show="isAlertWaitForOther()">Wait for other to place the move</v-alert>
                        {% verbatim %}
                        <v-alert type="success" color="blue" v-show="isAlertResultShow()">{{result}}</v-alert>
                        {% endverbatim %}
                        <v-alert type="warning" color="orange" v-show="isAlertReconnectingShow()">Reconnecting...</v-alert>
                    </v-container>
                </v-main>
            </v-app>
        </div>

        <script src="{% static 'webapp1/tic-tac-toe/v2/connection.js' %}"></script>
        <script src="{% static 'webapp1/tic-tac-toe/v2/engine.js' %}"></script>
        <script src="{% static 'webapp1/tic-tac-toe/v2/game_rule.js' %}"></script>
        <script src="{% static 'webapp1/tic-tac-toe/v2/judge_ctrl.js' %}"></script>
        <script src="{% static 'webapp1/tic-tac-toe/v2/playground_equipment.js' %}"></script>
        <script src="{% static 'webapp1/tic-tac-toe/v2/protocol_main.js' %}"></script>
        <script src="{% static 'webapp1/tic-tac-toe/v2/protocol_messages.js' %}"></script>
        <script src="{% static 'webapp1/tic-tac-toe/v2/user_ctrl.js' %}"></script>

        <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
        <script>
            const STATE_DURING_GAME = "DuringGame";
            const STATE_GAME_IS_OVER = "GameIsOver";

            const RESULT_WON = "Won";
            const RESULT_LOST = "Lost";
            const RESULT_DRAW = "Draw";

            /**
             * 再接続関数の作成
             * @return ラムダ関数
             */
            function packReconnect() {
                // 5秒後に1回だけ再接続にトライします。
                // そのあと接続が切れれば また再接続が呼び出されるので連続します
                return () => {
                    console.log("[Reconnect] Start...");
                    vue1.engine.connection.isReconnectingDisplay = true;

                    setTimeout(() => {
                        // このコードブロックでは、 this の指しているものが コードブロックの外側のオブジェクトではないので注意
                        console.log("[Reconnect] Try...");
                        vue1.engine.connect();

                        vue1.engine.connection.isReconnectingDisplay = false;
                        console.log("[Reconnect] End");
                    }, 5000);
                };
            }

            let vue1 = new Vue({
                el: "#app",
                vuetify: new Vuetify(),
                data: {
                    engine: new Engine(
                        createSetMessageFromServer(),
                        packReconnect(),
                        // 部屋名
                        document.forms["form1"]["room_name"].value,
                        // X か O
                        document.forms["form1"]["my_piece"].value,
                        // 接続文字列を返す関数 (roomName, myPiece)=>{return connectionString;}
                        (roomName, myPiece) => {
                            // 接続文字列
                            const connectionString = `ws://${window.location.host}/tic-tac-toe/v2/play/${roomName}/`;
                            //                                                                  ^
                            //                        ----]----------------------]---------------------------------
                            //                        1    2                      3
                            // 1. プロトコル（Web socket）
                            // 2. ホスト アドレス
                            // 3. パス
                            // console.log(`[Debug] new Engine ... roomName=${roomName} myPiece=${myPiece} connectionString=${connectionString}`);

                            return connectionString;
                        }
                    ),
                    state: STATE_DURING_GAME,
                    result: "",
                    label0: PC_EMPTY_LABEL,
                    label1: PC_EMPTY_LABEL,
                    label2: PC_EMPTY_LABEL,
                    label3: PC_EMPTY_LABEL,
                    label4: PC_EMPTY_LABEL,
                    label5: PC_EMPTY_LABEL,
                    label6: PC_EMPTY_LABEL,
                    label7: PC_EMPTY_LABEL,
                    label8: PC_EMPTY_LABEL,
                },
                // page loaded
                mounted: () => {
                    // ここで Vue の準備完了後の処理ができる。
                    // ただし、まだ this は初期化されてない
                },
                methods: {
                    // 画面を初期化
                    init() {
                        // console.log("[Debug] Vue#init()");

                        this.engine.setup(this.packSetLabelOfButton());

                        this.setState(STATE_DURING_GAME);

                        this.engine.userCtrl.init(this.engine.connection.myPiece);

                        // ボタンのラベルをクリアー
                        for (let sq = 0; sq < BOARD_AREA; sq += 1) {
                            this.setLabelOfButton(sq, PC_EMPTY_LABEL);
                        }
                    },
                    /**
                     * 升ボタンをクリックしたとき
                     * @param {*} sq - Square; 0 <= sq
                     */
                    clickSquare(sq) {
                        // console.log(`[Debug] Vue#clickSquare sq=${sq} this.engine.userCtrl.isMyTurn=${this.engine.userCtrl.isMyTurn}`);

                        if (this.engine.playeq.getPieceBySq(sq) == PC_EMPTY) {
                            if (!this.engine.userCtrl.isMyTurn) {
                                // Wait for other to place the move
                                console.log("Wait for other to place the move");
                                this.engine.userCtrl.isWaitForOther = true;
                            } else {
                                this.engine.userCtrl.isMyTurn = false;

                                this.engine.userCtrl.doMove(parseInt(sq), this.engine.connection.myPiece);
                            }
                        }
                    },
                    /**
                     * 升ボタンのラベル変更
                     * @param {number} sq - Square; 0 <= sq
                     * @param {*} piece - text
                     */
                    setLabelOfButton(sq, piece) {
                        // console.log(`[Debug] Vue#setLabelOfButton sq=${sq} piece=${piece}`);

                        switch (sq) {
                            case 0:
                                this.label0 = piece;
                                break;
                            case 1:
                                this.label1 = piece;
                                break;
                            case 2:
                                this.label2 = piece;
                                break;
                            case 3:
                                this.label3 = piece;
                                break;
                            case 4:
                                this.label4 = piece;
                                break;
                            case 5:
                                this.label5 = piece;
                                break;
                            case 6:
                                this.label6 = piece;
                                break;
                            case 7:
                                this.label7 = piece;
                                break;
                            case 8:
                                this.label8 = piece;
                                break;
                            default:
                                alert(`[Error] sq=${sq}`);
                                break;
                        }
                    },
                    /**
                     * @return {*} ラムダ関数
                     */
                    packSetLabelOfButton() {
                        return (sq, piece) => {
                            this.setLabelOfButton(sq, piece);
                        };
                    },
                    /**
                     *
                     */
                    setState(state) {
                        this.state = state;
                    },
                    /**
                     * 対局は終了しました
                     */
                    setGameIsOver(result) {
                        // console.log(`[Debug][setGameIsOver] result=${result}`);

                        this.setState(STATE_GAME_IS_OVER); // 画面を対局終了状態へ

                        switch (result) {
                            case RESULT_DRAW:
                                this.result = "It's a draw.";
                                break;
                            case RESULT_WON:
                                this.result = "You win!";
                                break;
                            case RESULT_LOST:
                                this.result = "You lose.";
                                break;
                            default:
                                throw `unknown result = ${result}`;
                        }
                    },
                    /**
                     * 対局中で、自分の手番ならアラートを常時表示
                     */
                    isAlertYourMoveShow() {
                        return this.state == STATE_DURING_GAME && this.engine.userCtrl.isMyTurn;
                    },
                    isAlertWaitForOther() {
                        return this.engine.userCtrl.isWaitForOther;
                    },
                    /**
                     * 対局が終了していたら、結果を常時表示
                     */
                    isAlertResultShow() {
                        return this.state == STATE_GAME_IS_OVER;
                    },
                    /**
                     * 再接続中表示中なら、アラートを常時表示
                     */
                    isAlertReconnectingShow() {
                        return this.engine.connection.isReconnectingDisplay;
                    },
                    {% block method_section1 %}
                    // あれば、ここにメソッドを置く
                    {% endblock method_section1 %}
                },
            });
        </script>
    </body>
</html>
