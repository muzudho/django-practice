# ç›®çš„

å‰ã®è¨˜äº‹ã§ã€ï¼‘äººï¼’å½¹ã§ï¼’çª“ã§éŠã¶ ã€‡Ã—ã‚²ãƒ¼ãƒ ï¼ˆTic tac toeï¼‰ã‚’ä½œã£ãŸã€‚  
ã“ã‚Œã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’ Vuetify ã«ç½®ãæ›ãˆãŸã„ã€‚  

# ã¯ã˜ã‚ã«

å‰æçŸ¥è­˜:  

| Key                                                            | Value                                                                                                                      |
| -------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------- |
| Webãƒ–ãƒ©ã‚¦ã‚¶è¶Šã—ã«ï¼’äººå¯¾æˆ¦ã§ãã‚‹ã€‡Ã—ã‚²ãƒ¼ãƒ ã®ä½œæˆæ–¹æ³•ã‚’çŸ¥ã£ã¦ãŠã | ğŸ“–[Djangoã‚’ä»‹ã—ã¦Webãƒ–ãƒ©ã‚¦ã‚¶è¶Šã—ã«ï¼’äººå¯¾æˆ¦ã§ãã‚‹ã€‡Ã—ã‚²ãƒ¼ãƒ ã‚’ä½œã‚ã†ï¼](https://qiita.com/muzudho1/items/3bd5e55fbea2c0598e8b) |

ã“ã®è¨˜äº‹ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£:  

| Key              | Value                                     |
| ---------------- | ----------------------------------------- |
| OS               | Windows10                                 |
| Container        | Docker                                    |
| Program Language | Python 3                                  |
| Web framework    | Django                                    |
| Communication    | Web socket                                |
|                  | JSON                                      |
| Frontend         | Vuetify                                   |
| Database         | Redis                                     |
| Editor           | Visual Studio Code ï¼ˆä»¥ä¸‹ VSCode ã¨è¡¨è¨˜ï¼‰ |

ã“ã®è¨˜äº‹ã¯ Lesson01 ã‹ã‚‰ç¶šã„ã¦ã„ã¦ã€é †ã«ã‚„ã£ã¦ã“ãªã„ã¨ ã‚½ãƒ¼ã‚¹ãŒè¶³ã‚Šãšå®Ÿè¡Œã§ããªã„ã®ã§æ³¨æ„ã•ã‚ŒãŸã„ã€‚  

ã“ã®é€£è¼‰ã®æœ€åˆã®ãƒšãƒ¼ã‚¸: ğŸ“– [Djangoã‚’Dockerã‚³ãƒ³ãƒ†ãƒŠã¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã‚ˆã†ï¼](https://qiita.com/muzudho1/items/eb0df0ea604e1fd9cdae)  

ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã‚’æŠœç²‹ã™ã‚‹ã¨ ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€‚  

```plaintext
â””â”€â”€ ğŸ“‚host1
     â”œâ”€â”€ ğŸ“‚data
     â”‚ã€€ã€€â””â”€â”€ ğŸ“‚db
     â”‚         â””â”€â”€ <ãŸãã•ã‚“ã®ã‚‚ã®>
     â”œâ”€â”€ ğŸ“‚webapp1
     â”‚ã€€ã€€â”œâ”€â”€ ğŸ“‚static
     â”‚ã€€ã€€â”‚    â””â”€â”€ ğŸ“‚tic-tac-toe1
     â”‚ã€€ã€€â”‚        â”œâ”€â”€ game.js
     â”‚ã€€ã€€â”‚        â””â”€â”€ main.css
     â”‚ã€€ã€€â”œâ”€â”€ ğŸ“‚templates
     â”‚ã€€ã€€â”‚    â””â”€â”€ ğŸ“‚tic-tac-toe1
     â”‚ã€€ã€€â”‚        â”œâ”€â”€ game.html
     â”‚ã€€ã€€â”‚        â””â”€â”€ index.html
     â”‚ã€€ã€€â”œâ”€â”€ ğŸ“‚tic_tac_toe1
     â”‚ã€€ã€€â”‚    â””â”€â”€ consumer1.py
     â”‚ã€€ã€€â”œâ”€â”€ ğŸ“„asgi.py
     â”‚ã€€ã€€â”œâ”€â”€ ğŸ“„models.py
     â”‚ã€€ã€€â”œâ”€â”€ ğŸ“„routing1.py
     â”‚ã€€ã€€â”œâ”€â”€ ğŸ“„settings.py
     â”‚ã€€ã€€â”œâ”€â”€ ğŸ“„urls.py
     â”‚ã€€ã€€â””â”€â”€ <ã„ã‚ã„ã‚>
     â”œâ”€â”€ ğŸ“„.env
     â”œâ”€â”€ ğŸ³docker-compose.yml
     â”œâ”€â”€ ğŸ³Dockerfile
     â”œâ”€â”€ ğŸ“„manage.py
     â”œâ”€â”€ ğŸ“„requirements.txt
     â””â”€â”€ <ã„ã‚ã„ã‚>
```

ä»¥ä¸‹ã€å‚è€ƒã«ã—ãŸå…ƒè¨˜äº‹ã¯ ğŸ“–[Django Channels and WebSockets](https://blog.logrocket.com/django-channels-and-websockets/) ã ã€‚  
ã‚ãŸã—ã®è¨˜äº‹ã¯å˜ã« **ã‚„ã£ã¦ã¿ãŸ** ãã‚‰ã„ã®ä½ç½®ã¥ã‘ã ã€‚  

# Step 1. protocol_messages.js ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã»ã—ã„ã€‚  

```plaintext
â””â”€â”€ ğŸ“‚host1
     â””â”€â”€ ğŸ“‚webapp1
       ã€€ã€€â””â”€â”€ ğŸ“‚static
       ã€€ã€€      â””â”€â”€ ğŸ“‚tic-tac-toe2
       ã€€ã€€            â””â”€â”€ protocol_messages.js ğŸ‘ˆ
```

```js
/**
 * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§
 *
 * * ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã‚µãƒ¼ãƒãƒ¼ã¸é€ã‚‹
 */
class ProtocolMessages {

    /**
     * ã©ã¡ã‚‰ã‹ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒçŸ³ã‚’ç½®ã„ãŸã¨ã
     * @param {*} sq - å‡ç•ªå·
     * @param {*} myPiece - X ã‹ O
     * @returns ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
     */
    createDoMove(sq, myPiece) {
        return {
            "event": "CtoS_Move",
            "sq": sq,
            "myPiece": myPiece,
        }
    }

    /**
     * å¼•ãåˆ†ã‘ãŸã¨ã
     * @returns ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
     */
    createDraw() {
        return {
            "event": "CtoS_End",
            "text": "It's a draw. Play again?"
        }
    }

    /**
     * å¯¾å±€ã‚’é–‹å§‹ã—ãŸã¨ã
     * @returns ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
     */
    createStart() {
        return {
            "event": "CtoS_Start",
        }
    }

    /**
     * ã©ã¡ã‚‰ã‹ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå‹ã£ãŸã¨ã
     * @param {*} myPiece - X ã‹ O
     * @returns ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
     */
    createWon(myPiece) {
        return {
            "event": "CtoS_End",
            "text": `${myPiece} is a winner. Play again?`
        }
    }
}
```

# Step 2. connection.js ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã»ã—ã„ã€‚  

```plaintext
â””â”€â”€ ğŸ“‚host1
     â””â”€â”€ ğŸ“‚webapp1
       ã€€ã€€â””â”€â”€ ğŸ“‚static
       ã€€ã€€      â””â”€â”€ ğŸ“‚tic-tac-toe2
       ã€€ã€€            â”œâ”€â”€ connection.js ğŸ‘ˆ
       ã€€ã€€            â””â”€â”€ protocol_messages.js
```

```js
// å‚è€ƒã«ã—ãŸè¨˜äº‹
// -------------
// ğŸ“–[Django Channels and WebSockets](https://blog.logrocket.com/django-channels-and-websockets/)

/**
 * æ¥ç¶š
 */
class Connection {

    constructor()
    {
        // éƒ¨å±‹å
        this.roomName = document.forms["form1"]["room_name"].value;

        // X ã‹ O ã‹
        this.myPiece = document.forms["form1"]["my_piece"].value;

        // æ¥ç¶šæ–‡å­—åˆ—
        this.connectionString = `ws://${window.location.host}/tic-tac-toe2/${this.roomName}/`;
        //                                                               ^
        //                      ---------------------------- -------------------------------
        //                      1                            2
        // 1. ãƒ›ã‚¹ãƒˆ ã‚¢ãƒ‰ãƒ¬ã‚¹
        // 2. URLã®ä¸€éƒ¨
        console.log($`[Debug] Connection#constructor roomName=${this.roomName} myPiece=${this.myPiece} connectionString=${this.connectionString}`)
    }

    /**
     * è¨­å®š
     * 
     * @param {*} onOpenWebSocket - Webã‚½ã‚±ãƒƒãƒˆã‚’é–‹ã‹ã‚ŒãŸã¨ã
     * @param {*} onCloseWebSocket - Webã‚½ã‚±ãƒƒãƒˆãŒé–‰ã˜ã‚‰ã‚ŒãŸã¨ãã€‚ ä¾‹: ã‚µãƒ¼ãƒãƒ¼å´ã«ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦æ¥ç¶šãŒåˆ‡ã‚ŒãŸã‚Šãªã©
     * @param {*} setMessageFromServer - ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚»ãƒƒãƒˆã•ã‚Œã‚‹é–¢æ•°
     */
    setup(onOpenWebSocket, onCloseWebSocket, setMessageFromServer) {
        console.log(`[Debug] Connection#setup`)
        this.webSock1 = new WebSocket(this.connectionString);
        this.webSock1.onopen = onOpenWebSocket;
        this.webSock1.onclose = onCloseWebSocket;

        // è¨­å®š: ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ãŸã¨ã
        this.webSock1.onmessage = (e) => {
            // JSON ã‚’è§£æã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã ã‘æŠ½å‡º
            let data1 = JSON.parse(e.data);
            let message = data1["message"];
            setMessageFromServer(message)
        };

        // Webã‚½ã‚±ãƒƒãƒˆã‚’æ¥ç¶šã—ã¾ã™
        this.connect();
    }

    /**
     * Main function which handles the connection
     * of websocket.
     */
    connect() {
        if (this.webSock1.readyState == WebSocket.OPEN) {
            console.log('Open socket.');
            this.webSock1.onopen();
        }
    }
}
```

# Step 3. game.js ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã»ã—ã„ã€‚  

```plaintext
â””â”€â”€ ğŸ“‚host1
     â””â”€â”€ ğŸ“‚webapp1
       ã€€ã€€â””â”€â”€ ğŸ“‚static
       ã€€ã€€      â””â”€â”€ ğŸ“‚tic-tac-toe2
       ã€€ã€€            â”œâ”€â”€ connection.js
       ã€€ã€€            â”œâ”€â”€ game.js ğŸ‘ˆ
       ã€€ã€€            â””â”€â”€ protocol_messages.js
```

```js
/**
 * PC ã¯ Piece ï¼ˆé§’ã€çŸ³ã€ãªã©ã®æ„å‘³ï¼‰ã®ç•¥ã§ã™ã€‚
 * @type {number}
 */
const PC_EMPTY = -1 // PieceãŒãªã„ã“ã¨ã‚’è¡¨ã—ã¾ã™
const PC_O = 0
const PC_X = 1

/**
 * ç›¤ä¸Šã®å‡ã®æ•°
 * @type {number}
 */
const BOARD_AREA = 9

/**
 * SQ is square
 * +---------+
 * | 0  1  2 |
 * | 3  4  5 |
 * | 6  7  8 |
 * +---------+
 * @type {number}
 */
const SQ_0 = 0
const SQ_1 = 1
const SQ_2 = 2
const SQ_3 = 3
const SQ_4 = 4
const SQ_5 = 5
const SQ_6 = 6
const SQ_7 = 7
const SQ_8 = 8

/**
 * çŸ³ãŒï¼“ã¤ä¸¦ã‚“ã§ã„ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³
 */
WIN_PATTERN = [
    // +---------+
    // | *  *  * |
    // | .  .  . |
    // | .  .  . |
    // +---------+
    [SQ_0, SQ_1, SQ_2],
    // +---------+
    // | .  .  . |
    // | *  *  * |
    // | .  .  . |
    // +---------+
    [SQ_3, SQ_4, SQ_5],
    // +---------+
    // | .  .  . |
    // | .  .  . |
    // | *  *  * |
    // +---------+
    [SQ_6, SQ_7, SQ_8],
    // +---------+
    // | *  .  . |
    // | *  .  . |
    // | *  .  . |
    // +---------+
    [SQ_0, SQ_3, SQ_6],
    // +---------+
    // | .  *  . |
    // | .  *  . |
    // | .  *  . |
    // +---------+
    [SQ_1, SQ_4, SQ_7],
    // +---------+
    // | .  .  * |
    // | .  .  * |
    // | .  .  * |
    // +---------+
    [SQ_2, SQ_5, SQ_8],
    // +---------+
    // | *  .  . |
    // | .  *  . |
    // | .  .  * |
    // +---------+
    [SQ_0, SQ_4, SQ_8],
    // +---------+
    // | .  .  * |
    // | .  *  . |
    // | *  .  . |
    // +---------+
    [SQ_2, SQ_4, SQ_6]
]

/**
 * ã‚²ãƒ¼ãƒ 
 */
class Game {
    constructor() {
        // åˆæœŸåŒ–
        this.reset()

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        this._onDoMove = () => {}
        this._onWon = () => {}
        this._onDraw = () => {}
    }

    /**
     * çŸ³ã‚’ç½®ã„ãŸã¨ã
     */
    set onDoMove(func) {
        this._onDoMove = func
    }

    /**
     * å‹ã£ãŸã¨ã
     */
    set onWon(func) {
        this._onWon = func
    }

    /**
     * å¼•ãåˆ†ã‘ãŸã¨ã
     */
    set onDraw(func) {
        this._onDraw = func
    }

    /**
     * åˆæœŸåŒ–
     */
    reset() {
        // ç›¤é¢
        this.board = [
            PC_EMPTY, PC_EMPTY, PC_EMPTY,
            PC_EMPTY, PC_EMPTY, PC_EMPTY,
            PC_EMPTY, PC_EMPTY, PC_EMPTY,
        ];

        this.countOfMove = 0;   // ä½•æ‰‹ç›®
        this.myTurn = true;     // è‡ªåˆ†ã®æ‰‹ç•ªã‹
    }

    /**
     * çŸ³ã‚’ç½®ãã¾ã™
     * @param {number} sq - å‡ç•ªå·; 0 <= sq
     * @param {*} myPiece - X ã‹ O
     * @returns çŸ³ã‚’ç½®ã‘ãŸã‚‰çœŸã€ãã‚Œä»¥å¤–ã¯å½
     */
    makeMove(sq, myPiece){

        if (this.board[sq] == PC_EMPTY) {
            // ç©ºå‡ãªã‚‰

            this.countOfMove++; // ä½•æ‰‹ç›®ã‚’ï¼‹ï¼‘

            // çŸ³ã‚’ç½®ãã¾ã™
            switch (myPiece) {
                case 'X':
                    this.board[sq] = PC_X;
                    break;
                case 'O':
                    this.board[sq] = PC_O;
                    break;
                default:
                    alert(`[Error] Invalid my piece = ${myPiece}`);
                    return false;
            }

            this._onDoMove(sq, myPiece)
        }

        // ãƒœã‚¿ãƒ³ã®ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°
        vue1.setLabelOfButton(sq, myPiece);

        if(this.myTurn){
            // çµ‚å±€åˆ¤å®š
            const gameOver = this.isGameOver();

            // æ‰“ã£ãŸå¾Œã€è² ã‘ã¨åˆ¤å®šã•ã‚ŒãŸãªã‚‰ã€ç›¸æ‰‹ãŒè² ã‘
            if (gameOver) {
                this._onWon(myPiece)
            }
            // ç›¤ãŒåŸ‹ã¾ã£ãŸã‚‰å¼•ãåˆ†ã‘
            else if (!gameOver && this.countOfMove == 9) {
                this._onDraw()
            }
        }

        return true
    }

    /**
     * æ‰‹ç•ªã‚’æŒã£ã¦ã„ã‚‹æ–¹ãŒå‹ã£ã¦ã„ã‚‹ã‹ï¼Ÿ
     * @returns å‹ã¡ãªã‚‰çœŸã€ãã‚Œä»¥å¤–ã¯å½
     */
    isGameOver(){
        if (5 <= this.countOfMove) {
            for (let squaresOfWinPattern of WIN_PATTERN) {
                if (this.isPieceInLine(squaresOfWinPattern)) {
                    return true;
                }
            }
        }
        return false;
    }

    /**
     * çŸ³ãŒï¼“ã¤ä¸¦ã‚“ã§ã„ã‚‹ã‹ï¼Ÿ
     * @param {*} squaresOfWinPattern - å‹ã¡ãƒ‘ã‚¿ãƒ¼ãƒ³
     * @returns ä¸¦ã‚“ã§ã„ã‚Œã°çœŸã€ãã‚Œä»¥å¤–ã¯å½
     */
    isPieceInLine(squaresOfWinPattern) {
        return this.board[squaresOfWinPattern[0]] !== PC_EMPTY &&
            this.board[squaresOfWinPattern[0]] === this.board[squaresOfWinPattern[1]] &&
            this.board[squaresOfWinPattern[0]] === this.board[squaresOfWinPattern[2]];
    }
}
```



# Step 5. game.js ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã»ã—ã„ã€‚  

ğŸ“„`host1/webapp1/static/tic-tac-toe1/game.js`:  

```js
// See also: ğŸ“–[Django Channels and WebSockets](https://blog.logrocket.com/django-channels-and-websockets/)

var roomName = document.getElementById("board").getAttribute("room_name");
var myPiece = document.getElementById("board").getAttribute("my_piece");

var connectionString = `ws://${window.location.host}/tic-tac-toe1/${roomName}/`;
//                           ----------------------- -------------------------
//                           1                       2
// 1. ãƒ›ã‚¹ãƒˆ ã‚¢ãƒ‰ãƒ¬ã‚¹
// 2. URLã®ä¸€éƒ¨

var webSock1 = new WebSocket(connectionString);

const PC_EMPTY = -1 // A square without piece; PC is piece
// Game board for maintaing the state of the game
var board = [
    PC_EMPTY, PC_EMPTY, PC_EMPTY,
    PC_EMPTY, PC_EMPTY, PC_EMPTY,
    PC_EMPTY, PC_EMPTY, PC_EMPTY,
];

// SQ is square
// +---------+
// | 0  1  2 |
// | 3  4  5 |
// | 6  7  8 |
// +---------+
const SQ_0 = 0
const SQ_1 = 1
const SQ_2 = 2
const SQ_3 = 3
const SQ_4 = 4
const SQ_5 = 5
const SQ_6 = 6
const SQ_7 = 7
const SQ_8 = 8
// Winning indexes.
arrayOfSquaresOfWinPattern = [
    // +---------+
    // | *  *  * |
    // | .  .  . |
    // | .  .  . |
    // +---------+
    [SQ_0, SQ_1, SQ_2],
    // +---------+
    // | .  .  . |
    // | *  *  * |
    // | .  .  . |
    // +---------+
    [SQ_3, SQ_4, SQ_5],
    // +---------+
    // | .  .  . |
    // | .  .  . |
    // | *  *  * |
    // +---------+
    [SQ_6, SQ_7, SQ_8],
    // +---------+
    // | *  .  . |
    // | *  .  . |
    // | *  .  . |
    // +---------+
    [SQ_0, SQ_3, SQ_6],
    // +---------+
    // | .  *  . |
    // | .  *  . |
    // | .  *  . |
    // +---------+
    [SQ_1, SQ_4, SQ_7],
    // +---------+
    // | .  .  * |
    // | .  .  * |
    // | .  .  * |
    // +---------+
    [SQ_2, SQ_5, SQ_8],
    // +---------+
    // | *  .  . |
    // | .  *  . |
    // | .  .  * |
    // +---------+
    [SQ_0, SQ_4, SQ_8],
    // +---------+
    // | .  .  * |
    // | .  *  . |
    // | *  .  . |
    // +---------+
    [SQ_2, SQ_4, SQ_6]
]
let countOfMove = 0; // Number of moves done
let myTurn = true; // Boolean variable to get the turn of the player.

// Add the click event listener on every block.
let elementArrayOfSquare = document.getElementsByClassName('square');
for (const element of elementArrayOfSquare) {
    element.addEventListener("click", event=>{
        const sq = event.path[0].getAttribute('square'); // Square; 0 <= sq
        if(board[sq] == PC_EMPTY){
            if(!myTurn){
                alert("Wait for other to place the move")
            }
            else{
                myTurn = false;
                document.getElementById("alert_move").style.display = 'none'; // Hide
                makeMove(sq, myPiece);
            }
        }
    })
}

/**
 * Make a move
 * @param {*} sq - Square; 0 <= sq
 * @param {*} myPiece 
 * @returns 
 */
function makeMove(sq, myPiece){
    sq = parseInt(sq);
    let data = {
        "event": "MOVE",
        "message": {
            "index": sq,
            "player": myPiece
        }
    }

    if(board[sq] == PC_EMPTY){
        // if the valid move, update the board
        // state and send the move to the server.
        countOfMove++;

        switch (myPiece) {
            case 'X':
                board[sq] = 1;
                break;
            case 'O':
                board[sq] = 0;
                break;
            default:
                alert(`Invalid my piece = ${myPiece}`);
                return false;
        }

        webSock1.send(JSON.stringify(data))
    }
    // place the move in the game box.
    elementArrayOfSquare[sq].innerHTML = myPiece;
    // check for the winner
    const gameOver = isGameOver();
    if(myTurn){
        // if player winner, send the END event.
        if(gameOver){
            data = {
                "event": "END",
                "message": `${myPiece} is a winner. Play again?`
            }
            webSock1.send(JSON.stringify(data))
        }
        else if(!gameOver && countOfMove == 9){
            data = {
                "event": "END",
                "message": "It's a draw. Play again?"
            }
            webSock1.send(JSON.stringify(data))
        }
    }
}

// function to reset the game.
function reset(){
    board = [
        PC_EMPTY, PC_EMPTY, PC_EMPTY,
        PC_EMPTY, PC_EMPTY, PC_EMPTY,
        PC_EMPTY, PC_EMPTY, PC_EMPTY,
    ];
    countOfMove = 0;
    myTurn = true;
    document.getElementById("alert_move").style.display = 'inline';
    for (const element of elementArrayOfSquare) {
        element.innerHTML = "";
    }
}

/**
 * check if their is winning move
 * @param {*} squaresOfWinPattern 
 * @returns 
 */
function isPieceInLine(squaresOfWinPattern) {
    return board[squaresOfWinPattern[0]] !== PC_EMPTY &&
        board[squaresOfWinPattern[0]] === board[squaresOfWinPattern[1]] &&
        board[squaresOfWinPattern[0]] === board[squaresOfWinPattern[2]];
}

/**
 * function to check if player is winner.
 * @returns I won
 */
function isGameOver(){
    if (5 <= countOfMove) {
        for (let squaresOfWinPattern of arrayOfSquaresOfWinPattern) {
            if (isPieceInLine(squaresOfWinPattern)) {
                return true;
            }
        }
    }
    return false;
}

/**
 * Main function which handles the connection
 * of websocket.
 */
function connect() {
    // on websocket open, send the START event.
    webSock1.onopen = () => {
        console.log('WebSockets connection created.');
        webSock1.send(JSON.stringify({
            "event": "START",
            "message": ""
        }));
    };

    webSock1.onclose = (e) => {
        console.log('Socket is closed. Reconnect will be attempted in 1 second.', e.reason);
        setTimeout(function () {
            connect();
        }, 1000);
    };

    // Sending the info about the room
    webSock1.onmessage = (e) => {
        // On getting the message from the server
        // Do the appropriate steps on each event.
        let data = JSON.parse(e.data);
        data = data["payload"];
        let message = data['message'];
        let event = data["event"];
        switch (event) {
            case "START":
                console.log(`[Message] START e=${e.data}`); // ã¡ã‚ƒã‚“ã¨å‹•ã„ã¦ã„ã‚‹ã‚ˆã†ãªã‚‰æ¶ˆã™
                reset();
                break;
            case "END":
                console.log(`[Message] END e=${e.data}`); // ã¡ã‚ƒã‚“ã¨å‹•ã„ã¦ã„ã‚‹ã‚ˆã†ãªã‚‰æ¶ˆã™
                alert(message);
                reset();
                break;
            case "MOVE":
                console.log(`[Message] MOVE e=${e.data}`); // ã¡ã‚ƒã‚“ã¨å‹•ã„ã¦ã„ã‚‹ã‚ˆã†ãªã‚‰æ¶ˆã™
                if(message["player"] != myPiece){
                    makeMove(message["index"], message["player"])
                    myTurn = true;
                    document.getElementById("alert_move").style.display = 'inline';
                }
                break;
            default:
                console.log(`[Message] (Others) e=${e.data}`); // ã¡ã‚ƒã‚“ã¨å‹•ã„ã¦ã„ã‚‹ã‚ˆã†ãªã‚‰æ¶ˆã™
                console.log("No event")
        }
    };

    if (webSock1.readyState == WebSocket.OPEN) {
        console.log('Open socket.');
        webSock1.onopen();
    }
}

//call the connect function at the start.
connect();
```

# Step 6. index.html ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã»ã—ã„ã€‚  

ğŸ“„`host1/webapp1/templates/tic-tac-toe1/index.html`:  

```html
{% load static %} {% comment %} ğŸ‘ˆã‚ã¨ã§ static "URL" ã‚’ä½¿ã†ã®ã§ load static ã—ã¾ã™ {% endcomment %}
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Tic Tac Toe</title>
        <link rel="stylesheet" href='{% static "/tic-tac-toe1/main.css" %}' />
    </head>
    <body>
        <div class="wrapper">
            <h1>Welcome to Tic Tac Toe Game</h1>
            <form method="POST">
                {% csrf_token %}
                <div class="form-control">
                    <label for="room">Room id</label>
                    <input id="room" type="text" name="room_name" required />
                </div>
                <div class="form-control">
                    <label for="item_of_my_piece">Your character</label>
                    <select for="item_of_my_piece" name="my_piece">
                        <option value="X">X</option>
                        <option value="O">O</option>
                    </select>
                </div>
                <input type="submit" class="button" value="Start Game" />
            </form>
        </div>
    </body>
</html>
```

# Step 7. game.html ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã»ã—ã„ã€‚  

ğŸ“„`host1/webapp1/templates/tic-tac-toe1/game.html`:  

```html
{% load static %} {% comment %} ğŸ‘ˆã‚ã¨ã§ static "URL" ã‚’ä½¿ã†ã®ã§ load static ã—ã¾ã™ {% endcomment %}
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Tic Tac Toe</title>
        <link rel="stylesheet" href='{% static "/tic-tac-toe1/main.css" %}' />
    </head>
    <body>
        <div class="wrapper">
            <div class="head">
                <h1>TIC TAC TOE</h1>
                <h3>Welcome to room_{{room_name}}</h3>
            </div>
            <div id="board" room_name="{{room_name}}" my_piece="{{my_piece}}">
                <div class="square" square="0"></div>
                <div class="square" square="1"></div>
                <div class="square" square="2"></div>
                <div class="square" square="3"></div>
                <div class="square" square="4"></div>
                <div class="square" square="5"></div>
                <div class="square" square="6"></div>
                <div class="square" square="7"></div>
                <div class="square" square="8"></div>
            </div>
            <div id="alert_move">Your turn. Place your move <strong>{{my_piece}}</strong></div>
        </div>

        <script src="{% static 'tic-tac-toe1/game.js' %}"></script>
        {% block javascript %} {% endblock javascript %}
    </body>
</html>
```

# Step 8. views.py ãƒ•ã‚¡ã‚¤ãƒ«ã®ç·¨é›†

ğŸ“„`host1/webapp1/views.py` ã«ã€ä»¥ä¸‹ã®è¨˜è¿°ã‚’è¿½åŠ ã—ã¦ã»ã—ã„ã€‚  

```py
from django.shortcuts import render, redirect
from django.http import Http404 # è¿½åŠ 


def indexOfTicTacToe1(request):
    """ï¼ˆè¿½åŠ ï¼‰ For Tic-tac-toe"""
    if request.method == "POST":
        room_name = request.POST.get("room_name")
        myPiece = request.POST.get("my_piece")
        return redirect(f'/tic-tac-toe1/{room_name}/?&mypiece={myPiece}')
    return render(request, "tic-tac-toe1/index.html", {})


def playGameOfTicTacToe1(request, room_name):
    """ï¼ˆè¿½åŠ ï¼‰ For Tic-tac-toe"""
    myPiece = request.GET.get("mypiece")
    if myPiece not in ['X', 'O']:
        raise Http404(f"My piece '{myPiece}' does not exists")
    context = {
        "my_piece": myPiece,
        "room_name": room_name
    }
    return render(request, "tic-tac-toe1/game.html", context)
```

# Step 9. urls.py ãƒ•ã‚¡ã‚¤ãƒ«ã®ç·¨é›†

ä»¥ä¸‹ã®è¨˜è¿°ã‚’è¿½åŠ ã—ã¦ã»ã—ã„ã€‚  

ğŸ“„`host1/webapp1/urls.py` ï¼ˆæŠœç²‹ï¼‰:

```py
from django.urls import path
from . import views

urlpatterns = [
    # ...ç•¥...

    # ï¼ˆè¿½åŠ ï¼‰
    path('tic-tac-toe1/', views.indexOfTicTacToe1),
    #     -------------
    #     1
    # 1. URLã®ä¸€éƒ¨

    # ï¼ˆè¿½åŠ ï¼‰
    path('tic-tac-toe1/<str:room_name>/', views.playGameOfTicTacToe1),
    #     -----------------------------
    #     1
    # 1. URLã®ä¸€éƒ¨ã€‚<room_name> ã«å…¥ã£ãŸæ–‡å­—åˆ—ã¯ room_name å¤‰æ•°ã«æ¸¡ã•ã‚Œã¾ã™
]
```

# Step 10. consumer1.py ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã»ã—ã„ã€‚  

ğŸ“„`host1/webapp1/tic_tac_toe1/consumer1.py`:  

```py
# See also: ğŸ“–[Django Channels and WebSockets](https://blog.logrocket.com/django-channels-and-websockets/)
import json
from channels.generic.websocket import AsyncJsonWebsocketConsumer


class TicTacToeConsumer1(AsyncJsonWebsocketConsumer):
    async def connect(self):
        self.room_name = self.scope['url_route']['kwargs']['room_name']
        self.room_group_name = 'room_%s' % self.room_name

        # Join room group
        await self.channel_layer.group_add(
            self.room_group_name,
            self.channel_name
        )
        await self.accept()

    async def disconnect(self, close_code):
        print("Disconnected")
        # Leave room group
        await self.channel_layer.group_discard(
            self.room_group_name,
            self.channel_name
        )

    async def receive(self, text_data):
        """
        Receive message from WebSocket.
        Get the event and send the appropriate event
        """
        print(
            f"[Debug] Consumer1 receive text_data={text_data}")  # ã¡ã‚ƒã‚“ã¨å‹•ã„ã¦ã„ã‚‹ã‚ˆã†ãªã‚‰æ¶ˆã™
        response = json.loads(text_data)
        event = response.get("event", None)
        message = response.get("message", None)
        if event == 'MOVE':
            # Send message to room group
            await self.channel_layer.group_send(self.room_group_name, {
                'type': 'send_message',
                'message': message,
                "event": "MOVE"
            })

        if event == 'START':
            # Send message to room group
            await self.channel_layer.group_send(self.room_group_name, {
                'type': 'send_message',
                'message': message,
                'event': "START"
            })

        if event == 'END':
            # Send message to room group
            await self.channel_layer.group_send(self.room_group_name, {
                'type': 'send_message',
                'message': message,
                'event': "END"
            })

    async def send_message(self, res):
        """ Receive message from room group """
        # Send message to WebSocket
        await self.send(text_data=json.dumps({
            "payload": res,
        }))
```

# Step 11. routing1.py ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

ç„¡ã‘ã‚Œã°ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã€ã‚ã‚Œã°ãƒãƒ¼ã‚¸ã—ã¦ã»ã—ã„ã€‚  

ğŸ“„`host1/webapp1/routing1.py`:  

```py
from django.conf.urls import url
from webapp1.tic_tac_toe1.consumer1 import TicTacToeConsumer1  # è¿½åŠ 
#    ------- ------------ ---------
#    1       2            3
# 1. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼å
# 2. ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ¼å
# 3. Python ãƒ•ã‚¡ã‚¤ãƒ«åã€‚æ‹¡å¼µå­æŠœã

websocket_urlpatterns = [
    # ï¼ˆè¿½åŠ ï¼‰ For Tic-tac-toe
    url(r'^tic-tac-toe1/(?P<room_name>\w+)/$', TicTacToeConsumer1.as_asgi()),
    #     ----------------------------------
    #     1
    # 1. URLã®ä¸€éƒ¨ï¼ˆæ­£è¦è¡¨ç¾ï¼‰ã® Django ã§ã®æ›¸ãæ–¹
]
```

# Step 12. asgi.py ãƒ•ã‚¡ã‚¤ãƒ«ã®ç·¨é›†

ç„¡ã‘ã‚Œã°ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã€ã‚ã‚Œã°ãƒãƒ¼ã‚¸ã—ã¦ã»ã—ã„ã€‚  

ğŸ“„`host1/webapp1/asgi.py`:  

```py
import os

from django.core.asgi import get_asgi_application
from channels.auth import AuthMiddlewareStack
from channels.routing import ProtocolTypeRouter, URLRouter
import webapp1.routing1
#      ------- --------
#      1       2
# 1. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼å
# 2. Pythonãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆæ‹¡å¼µå­é™¤ãï¼‰

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'webapp1.settings')
#                                                -------
#                                                1
# 1. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼å

# ï¼ˆå‰Šé™¤ï¼‰ application = get_asgi_application()
application = ProtocolTypeRouter({ # è¿½åŠ 
    "http": get_asgi_application(),
    "websocket": AuthMiddlewareStack(
        URLRouter(
            webapp1.routing1.websocket_urlpatterns
            # -----
            # 1
            #
            # 1. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼å
        )
    ),
})
```

# Step 13. Webç”»é¢ã¸ã‚¢ã‚¯ã‚»ã‚¹

ï¼ˆã—ã¦ã„ãªã‘ã‚Œã°ï¼‰Dockerã‚³ãƒ³ãƒ†ãƒŠã®èµ·å‹•  

```shell
cd host1

docker-compose up
```

ã“ã®ã‚²ãƒ¼ãƒ ã¯ï¼’äººç”¨ãªã®ã§ã€Webãƒšãƒ¼ã‚¸ã‚’ï¼’çª“ã§é–‹ãã€ç‰‡æ–¹ãŒ X ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã€ã‚‚ã†ç‰‡æ–¹ãŒ O ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦éŠã‚“ã§ãã ã•ã„ã€‚  

ğŸ“– [http://localhost:8000/tic-tac-toe1/](http://localhost:8000/tic-tac-toe1/)  

# å‚è€ƒã«ã—ãŸè¨˜äº‹

ğŸ“– [Django Channels and WebSockets](https://blog.logrocket.com/django-channels-and-websockets/)  
